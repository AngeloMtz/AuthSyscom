// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       Int    @id @default(autoincrement())
  nombre   String @db.VarChar(80)
  apellidos String @db.VarChar(100)
  email    String @unique @db.VarChar(100)
  telefono String @unique @db.VarChar(15)
  passwordHash String @map("password_hash") @db.Text
  
  // Estados de verificación
  verificadoEmail Boolean @default(false) @map("verificado_email")
  verificadoSms   Boolean @default(false) @map("verificado_sms")
  
  // Rol y estado
  rol    String @default("cliente") @db.VarChar(20)
  estado String @default("pendiente") @db.VarChar(20)
  
  // Campos adicionales de seguridad
  intentosFallidos Int       @default(0) @map("intentos_fallidos")
  bloqueadoHasta   DateTime? @map("bloqueado_hasta")
  
  // Timestamp
  creadoEn DateTime @default(now()) @map("creado_en")
  
  // Relaciones
  otpCodes OtpCode[]
  
  @@map("users")
}

model OtpCode {
  id      Int    @id @default(autoincrement())
  userId  Int    @map("user_id")
  codigo  String @db.VarChar(6)
  tipo    String @db.VarChar(20) // 'registro', 'login', 'recuperacion'
  canal   String @db.VarChar(10) // 'email', 'sms'
  expiracion DateTime
  utilizado  Boolean @default(false)
  
  // Relación
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([codigo, tipo])
  @@map("otp_codes")
}

// Tabla adicional para sesiones (opcional pero recomendada)
model Session {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.Text
  expiraEn  DateTime @map("expira_en")
  creadoEn  DateTime @default(now()) @map("creado_en")
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}